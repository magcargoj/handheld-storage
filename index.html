<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Handheld Storage Calculator | Steam Deck, Switch 2 & ROG Ally</title>
    <meta name="description" content="Calculate exactly which SD card or SSD you need for your Steam Deck, Nintendo Switch 2, or Retro Handheld. Build your game library and save money.">
    <meta name="keywords" content="Steam Deck Storage Calculator, Switch 2 SD Card Size, Steam Deck SSD Calculator, ROG Ally Storage Planner, Retro Handheld SD Card Guide">
    <meta name="author" content="HandheldMaster">

    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="shortcut icon" href="favicon.ico">

    <meta property="og:title" content="Handheld Storage Calculator ðŸ’¾">
    <meta property="og:description" content="Calculate exactly how many games fit on your Steam Deck or Switch.">

    <style>
        :root {
            --bg: #0f172a; --surface: #1e293b; --primary: #8b5cf6;
            --accent: #06b6d4; --text: #f8fafc; --border: #334155;
        }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 20px; padding-bottom: 180px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 {
            text-align: center; font-size: 2.2rem; margin-bottom: 10px;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .subtitle { text-align: center; color: #94a3b8; margin-bottom: 40px; }

        /* Inputs */
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--accent); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        select, input {
            width: 100%; padding: 14px; background: var(--surface);
            border: 2px solid var(--border); color: white; border-radius: 10px;
            box-sizing: border-box; font-size: 1rem;
        }
        select:focus, input:focus { outline: none; border-color: var(--primary); }

        /* Game Grid */
        .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 15px; }
        .game-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 8px; padding: 15px; cursor: pointer; transition: 0.2s;
        }
        .game-card:hover { transform: translateY(-2px); border-color: #64748b; }
        .game-card.selected {
            background: rgba(139, 92, 246, 0.2); border-color: var(--primary);
        }
        .game-title { font-weight: 600; font-size: 0.9rem; display: block; }
        .game-size { font-size: 0.8rem; color: #94a3b8; margin-top: 5px; display: block; }

        /* Retro Section */
        .retro-box {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        .retro-item { display: flex; justify-content: space-between; align-items: center; }
        .retro-input { width: 70px; padding: 8px; text-align: center; background: var(--bg); }

        /* Dock */
        .dock {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15, 23, 42, 0.98); border-top: 1px solid var(--border);
            padding: 20px; box-shadow: 0 -10px 40px rgba(0,0,0,0.5); z-index: 100;
        }
        .dock-inner { max-width: 800px; margin: 0 auto; display: flex; gap: 20px; align-items: center; }
        .total-box { min-width: 120px; }
        .total-val { font-size: 2.2rem; font-weight: 800; line-height: 1; }
        
        .rec-box { flex: 1; }
        .rec-buttons { display: flex; gap: 10px; margin-top: 8px; }
        .btn {
            flex: 1; padding: 10px; border-radius: 6px; text-decoration: none;
            text-align: center; font-weight: bold; font-size: 0.9rem;
            display: flex; flex-direction: column; justify-content: center;
        }
        .btn small { font-weight: normal; font-size: 0.75rem; opacity: 0.9; }
        .btn-sd { background: #fbbf24; color: #000; }
        .btn-ssd { background: #ef4444; color: #fff; }
        .btn:hover { filter: brightness(1.1); }
        .hidden { display: none !important; }

        @media (max-width: 600px) {
            .retro-box { grid-template-columns: 1fr; }
            .dock-inner { flex-direction: column; align-items: stretch; }
            .total-box { text-align: center; margin-bottom: 10px; }
        }
    </style>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’¾</text></svg>">
</head>

<body>

<div class="container">
    <h1>Handheld Storage Master</h1>
    <p class="subtitle">Smart Calculator with SSD & SD Recommendations</p>

    <div style="margin-bottom: 30px;">
        <label>1. Select Device</label>
        <select id="deviceSelect"><option>Loading devices...</option></select>
    </div>

    <div style="margin-bottom: 30px;">
        <label>2. Retro Collection (Qty)</label>
        <div class="retro-box">
            <div class="retro-item"><span>NES/SNES/GBA</span><input type="number" class="retro-input" data-size="0.01"></div>
            <div class="retro-item"><span>N64/DS/Dreamcast</span><input type="number" class="retro-input" data-size="0.2"></div>
            <div class="retro-item"><span>PS1/PSP</span><input type="number" class="retro-input" data-size="0.6"></div>
            <div class="retro-item"><span>PS2/GameCube</span><input type="number" class="retro-input" data-size="3.0"></div>
        </div>
    </div>

    <div>
        <label>3. Add Modern Games</label>
        <input type="text" id="searchInput" placeholder="Search games...">
        <div class="game-grid" id="gameGrid"></div>
    </div>
</div>

<div class="dock hidden" id="resultDock">
    <div class="dock-inner">
        <div class="total-box">
            <div style="font-size:0.8rem; color:#94a3b8; text-transform:uppercase;">Total Needed</div>
            <div class="total-val" id="totalDisplay">0 <span style="font-size:1rem; color:var(--primary)">GB</span></div>
        </div>
        <div class="rec-box">
            <div id="recText" style="font-size:0.95rem; color:#e2e8f0;">Calculation...</div>
            <div class="rec-buttons" id="recButtons"></div>
        </div>
    </div>
</div>

<script>
    // GLOBAL STATE
    let db = { games: [], devices: [], products: {} };
    let state = { selectedGames: new Set(), device: null };

    // INIT
    async function init() {
        try {
            const [g, d, p] = await Promise.all([
                fetch('games.json').then(r => r.json()),
                fetch('devices.json').then(r => r.json()),
                fetch('products.json').then(r => r.json())
            ]);
            db.games = g;
            db.devices = d;
            db.products = p;
            
            populateDeviceSelect();
            renderGames();
            
            // Listeners
            document.getElementById('deviceSelect').addEventListener('change', onDeviceChange);
            document.getElementById('searchInput').addEventListener('input', renderGames);
            document.querySelectorAll('.retro-input').forEach(el => el.addEventListener('input', calculate));
            
            // Set initial
            state.device = db.devices[0];
            calculate();

        } catch (e) {
            document.querySelector('h1').innerText = "Error Loading Data Files";
            console.error(e);
        }
    }

    function populateDeviceSelect() {
        const sel = document.getElementById('deviceSelect');
        sel.innerHTML = '';
        
        // Group by category
        const cats = {};
        db.devices.forEach(d => {
            if(!cats[d.category]) cats[d.category] = [];
            cats[d.category].push(d);
        });

        for (const [cat, devs] of Object.entries(cats)) {
            const group = document.createElement('optgroup');
            group.label = cat;
            devs.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.innerText = d.label;
                group.appendChild(opt);
            });
            sel.appendChild(group);
        }
        state.device = db.devices[0];
    }

    function onDeviceChange(e) {
        state.device = db.devices.find(d => d.id === e.target.value);
        state.selectedGames.clear(); // Clear games on switch to avoid confusion
        document.querySelectorAll('.retro-input').forEach(i => i.value = '');
        renderGames();
        calculate();
    }

    function renderGames() {
        const grid = document.getElementById('gameGrid');
        grid.innerHTML = '';
        const term = document.getElementById('searchInput').value.toLowerCase();
        
        // Determine platform key for sizes (e.g. "pc", "switch2", "switch")
        // Mapping logic: if device ID contains 'switch2' -> switch2, 'switch' -> switch, else 'pc'
        let sizeKey = 'pc';
        if (state.device.id.includes('switch2')) sizeKey = 'switch2';
        else if (state.device.id.includes('switch')) sizeKey = 'switch';

        const filtered = db.games.filter(g => {
            // Must have size for this platform
            if (g.sizes[sizeKey] === null) return false;
            return g.title.toLowerCase().includes(term);
        });

        // Sort selected first
        filtered.sort((a,b) => (state.selectedGames.has(a.id) ? -1 : 1));

        // Show max 12 if no search
        const toShow = term ? filtered : filtered.slice(0, 12);

        toShow.forEach(g => {
            const size = g.sizes[sizeKey];
            const el = document.createElement('div');
            el.className = `game-card ${state.selectedGames.has(g.id) ? 'selected' : ''}`;
            el.innerHTML = `<span class="game-title">${g.title}</span><span class="game-size">${size} GB</span>`;
            el.onclick = () => {
                if (state.selectedGames.has(g.id)) state.selectedGames.delete(g.id);
                else state.selectedGames.add(g.id);
                renderGames();
                calculate();
            };
            grid.appendChild(el);
        });
    }

    function calculate() {
        // 1. Calc Total
        let total = 0;
        let sizeKey = 'pc';
        if (state.device.id.includes('switch2')) sizeKey = 'switch2';
        else if (state.device.id.includes('switch')) sizeKey = 'switch';

        state.selectedGames.forEach(id => {
            const g = db.games.find(x => x.id === id);
            if(g) total += g.sizes[sizeKey];
        });

        document.querySelectorAll('.retro-input').forEach(i => {
            total += (parseInt(i.value)||0) * parseFloat(i.dataset.size);
        });

        // Only add OS buffer if games selected
        if(total > 0) total = Math.ceil(total + 20);

        // 2. Render Results
        const dock = document.getElementById('resultDock');
        const totalDisp = document.getElementById('totalDisplay');
        const recText = document.getElementById('recText');
        const btnBox = document.getElementById('recButtons');

        if(total === 0) {
            dock.classList.add('hidden');
            return;
        }
        dock.classList.remove('hidden');
        totalDisp.innerHTML = `${total} <span style="font-size:1rem;color:var(--primary)">GB</span>`;

        // 3. Recommendation Logic (The Brains)
        let html = '';
        
        // Find best SD card
        const sdType = state.device.sd_type; 
        const sdProducts = db.products[sdType] || [];
        // Simple logic: find smallest card > total
        let bestSD = sdProducts.find(p => p.cap >= total);
        if (!bestSD && sdProducts.length > 0) bestSD = sdProducts[sdProducts.length-1]; // Max out

        // Find best SSD (if supported)
        let bestSSD = null;
        if (state.device.ssd_type) {
            const ssdList = db.products[state.device.ssd_type] || [];
            bestSSD = ssdList.find(p => p.cap >= total);
            if (!bestSSD && ssdList.length > 0) bestSSD = ssdList[ssdList.length-1];
        }

        // SCENARIO 1: Device has SSD + SD (e.g. Steam Deck)
        if (state.device.ssd_type) {
            if (total > 800) {
                // Large Library: Recommend SSD
                recText.innerHTML = `ðŸ”¥ <strong>Power User!</strong> For ${total}GB, you need an SSD upgrade.`;
                if(bestSSD) html += `<a href="${bestSSD.link}" target="_blank" class="btn btn-ssd">${bestSSD.name}<small>Internal Upgrade</small></a>`;
                html += `<a href="${bestSD.link}" target="_blank" class="btn btn-sd">${bestSD.name}<small>MicroSD Backup</small></a>`;
            } else {
                // Small Library: Recommend SD (Cheaper)
                recText.innerHTML = `You can fit this on a MicroSD, but an SSD is faster.`;
                html += `<a href="${bestSD.link}" target="_blank" class="btn btn-sd">${bestSD.name}<small>Best Value</small></a>`;
                if(bestSSD) html += `<a href="${bestSSD.link}" target="_blank" class="btn btn-ssd" style="opacity:0.6">${bestSSD.name}<small>Faster Option</small></a>`;
            }
        } 
        // SCENARIO 2: SD Only Device (Switch / Retro)
        else {
            recText.innerHTML = `Recommended Card for <strong>${state.device.label}</strong>:`;
            if(bestSD) html += `<a href="${bestSD.link}" target="_blank" class="btn btn-sd">${bestSD.name}<small>View on Amazon</small></a>`;
        }

        btnBox.innerHTML = html;
    }

    init();
</script>
</body>
</html>
